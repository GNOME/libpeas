stages:
  - 'build'
  - 'deploy'

.build:
  image: 'registry.fedoraproject.org/fedora:38'
  stage: 'build'
  variables:
    CCACHE_BASEDIR: "${CI_PROJECT_DIR}"
    CCACHE_DIR: "${CI_PROJECT_DIR}/_ccache"
    DEPS: >-
      gcc
      gcc-c++
      ccache
      gettext
      meson
      ninja-build
      redhat-rpm-config
      glib2-devel
      gobject-introspection-devel
      python3-devel
      python3-packaging
      python3-gobject-devel
      xorg-x11-server-Xvfb
      git
      pip
      luajit-devel
      lua-lgi-compat
      gi-docgen
      vala
      mozjs102-devel
  before_script:
    - "dnf install -y $DEPS"
    - 'mkdir -p _ccache'
    - 'ccache --zero-stats'
    - 'ccache --show-stats'
    - 'pip install markdown markupsafe pygments jinja2 toml typogrify'
    - 'git clone https://gitlab.gnome.org/GNOME/gjs.git'
    - 'meson setup _build_gjs gjs/ --prefix=/usr -Dskip_dbus_tests=true -Dskip_gtk_tests=false -Dprofiler=disabled -Dreadline=disabled -Dinstalled_tests=false'
    - 'ninja -C _build_gjs install'
  after_script:
    - 'ccache --show-stats'
  cache:
    key: "$CI_JOB_NAME"
    paths:
      - '_ccache/'

build peas:
  extends: '.build'
  script:
    - 'meson -Dintrospection=true -Dvapi=true -Dgtk_doc=false _build .'
    - 'ninja -C _build test'

reference:
  extends: '.build'
  variables:
    MESON_ARGS: >-
      -Dgtk_doc=true -Dgjs=false -Dlua51=false -Dpython3=false
  script:
    - mkdir -p _reference/libpeas-2
    - meson ${MESON_ARGS} _build
    - ninja -C _build
    - mv _build/docs/reference/libpeas-2/* _reference/libpeas-2
  artifacts:
    paths:
      - _reference

pages:
  stage: deploy
  needs: ['reference']
  script:
    - mv _reference public
  artifacts:
    when: on_success
    paths:
      - public
